---
phase: 01-foundation
plan: "04"
type: execute
wave: 3
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - supabase/migrations/20260226000001_initial_schema.sql
  - supabase/migrations/20260226000002_seed_countries.sql
autonomous: false
requirements:
  - INFRA-06
  - INFRA-07
  - DATA-01
  - DATA-02
  - DATA-03
  - DATA-04
  - DATA-05

must_haves:
  truths:
    - "Running `supabase migration list` shows both migrations as applied to the remote project"
    - "All six tables exist in Supabase: `countries`, `economic_indicators`, `political_data`, `crime_statistics`, `migration_data`, `sync_log`"
    - "The `countries` table contains exactly 27 rows â€” all EU member states with code, name_es, name_en, flag_emoji"
    - "Every metric table has `source TEXT NOT NULL` and `source_url TEXT NOT NULL` columns â€” a row without these cannot be inserted"
    - "Every metric value column is nullable `NUMERIC` â€” inserting NULL is valid, inserting 0 for missing data is not blocked at DB level but is a convention enforced by application"
    - "A `UNIQUE` constraint on `(country_id, metric, year)` exists on all four metric tables â€” re-running a seed does not create duplicate rows"
    - "The `sync_log` table has a `CHECK (status IN ('success', 'failure'))` constraint"
  artifacts:
    - path: "supabase/migrations/20260226000001_initial_schema.sql"
      provides: "DDL for all 6 tables with NOT NULL constraints on source columns, nullable value columns, UNIQUE constraints"
      contains: "CREATE TABLE countries"
    - path: "supabase/migrations/20260226000002_seed_countries.sql"
      provides: "EU-27 INSERT statements for the countries table"
      contains: "INSERT INTO countries"
  key_links:
    - from: "supabase/migrations/20260226000001_initial_schema.sql"
      to: "Supabase remote project"
      via: "supabase db push"
      pattern: "UNIQUE (country_id, metric, year)"
    - from: "supabase/migrations/20260226000002_seed_countries.sql"
      to: "countries table"
      via: "supabase db push"
      pattern: "INSERT INTO countries"
    - from: "economic_indicators"
      to: "countries"
      via: "REFERENCES countries(id)"
      pattern: "country_id.*REFERENCES"

user_setup:
  - service: supabase-cli
    why: "Required to create and push migration files"
    env_vars: []
    dashboard_config:
      - task: "Install Supabase CLI if not already installed"
        location: "Terminal: npm install -g supabase OR brew install supabase/tap/supabase"
      - task: "Link local project to remote Supabase project"
        location: "Terminal: supabase login && supabase link --project-ref YOUR_PROJECT_REF"
---

<objective>
Create all database migration files for the EuroData schema and push them to Supabase. Seed the `countries` table with all EU-27 member states.

Purpose: This is the final foundational piece. All data ingestion in Phases 2-5 writes to these tables. The schema design encodes the critical data quality conventions at the Postgres level: `source` and `source_url` are NOT NULL (a row without provenance cannot exist), metric values are nullable (missing data is NULL, not 0), and UNIQUE constraints on `(country_id, metric, year)` make seed re-runs idempotent.

Output: Six tables in Supabase, EU-27 countries seeded, schema version-controlled via migration files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

<interfaces>
<!-- DB schema design principles â€” locked decisions from STATE.md -->
<!--
1. source TEXT NOT NULL â€” every row must have a source name
2. source_url TEXT NOT NULL â€” every row must have a source URL
3. value NUMERIC (nullable) â€” missing data is NULL, never 0
4. UNIQUE (country_id, metric, year) â€” upsert-safe; Phase 6 ETL uses ON CONFLICT DO UPDATE
5. unit TEXT NOT NULL â€” documents the canonical unit (EUR/year, rate per 100k, etc.)
6. All metric tables have identical column structure (same pattern for economic, political, crime, migration)
-->

<!-- Full schema from research â€” use exactly as-is, do not modify -->
The complete DDL is in 01-RESEARCH.md Pattern 5. The executor MUST use this exact schema without modification.

Key constraint summary:
- countries: id SERIAL, code CHAR(2) UNIQUE NOT NULL, name_es TEXT NOT NULL, name_en TEXT NOT NULL, flag_emoji TEXT NOT NULL
- economic_indicators: UNIQUE (country_id, metric, year), value NUMERIC (nullable), source/source_url NOT NULL
- political_data: same structure as economic_indicators
- crime_statistics: same structure as economic_indicators
- migration_data: same structure as economic_indicators
- sync_log: status CHECK IN ('success', 'failure'), error_message nullable

<!-- EU-27 country codes for verification -->
AT BE BG HR CY CZ DK EE FI FR DE GR HU IE IT LV LT LU MT NL PL PT RO SK SI ES SE
(27 countries â€” verify the seed INSERT has exactly 27 rows)
</interfaces>
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Install Supabase CLI and link to remote project</name>
  <files></files>
  <action>
    The Supabase CLI is required to create migration files and push to the remote project. This step requires terminal commands run by the human (CLI installation and login).

    Steps:
    1. Install Supabase CLI (if not already installed):
       ```bash
       # Option A: npm global install
       npm install -g supabase

       # Option B: Homebrew (macOS)
       brew install supabase/tap/supabase

       # Option C: Windows (winget)
       winget install Supabase.CLI
       ```
    2. Verify installation: `supabase --version` (should return version number)
    3. Login to Supabase:
       ```bash
       supabase login
       ```
       This opens a browser for OAuth authentication.
    4. Find your project reference ID from the Supabase dashboard URL:
       `https://supabase.com/dashboard/project/YOUR-REF-HERE`
    5. Link the local project:
       ```bash
       cd C:/Users/jorge/Desktop/EuroScope  # or your project root
       supabase link --project-ref YOUR_PROJECT_REF
       ```
       Enter the database password when prompted (the one set during project creation in Plan 03).
    6. Verify link: `supabase status` should show connected project info.

    After completing these steps, type "ready" to continue.
  </action>
  <verify>
    supabase --version returns a version number.
    supabase status shows the linked project ref matching the Supabase dashboard URL.
  </verify>
  <done>Supabase CLI installed, authenticated, and linked to the eurodata remote project</done>
</task>

<task type="auto">
  <name>Task 2: Write migration files and push schema to Supabase</name>
  <files>
    supabase/migrations/20260226000001_initial_schema.sql
    supabase/migrations/20260226000002_seed_countries.sql
  </files>
  <action>
    Create the migration files directly (do NOT use `supabase migration new` which would generate different timestamps â€” create the files with these exact names to match the research-documented filenames):

    Create `supabase/migrations/20260226000001_initial_schema.sql` with the exact DDL from the research (Pattern 5):

    ```sql
    -- supabase/migrations/20260226000001_initial_schema.sql
    -- EuroData initial schema
    -- Data quality conventions:
    --   source/source_url: NOT NULL â€” every row must have provenance
    --   value: nullable NUMERIC â€” missing data is NULL, never 0
    --   UNIQUE (country_id, metric, year): makes upserts idempotent

    CREATE TABLE countries (
      id         SERIAL      PRIMARY KEY,
      code       CHAR(2)     NOT NULL UNIQUE,   -- ISO 3166-1 alpha-2
      name_es    TEXT        NOT NULL,
      name_en    TEXT        NOT NULL,
      flag_emoji TEXT        NOT NULL
    );

    CREATE TABLE economic_indicators (
      id          BIGSERIAL   PRIMARY KEY,
      country_id  INTEGER     NOT NULL REFERENCES countries(id),
      metric      TEXT        NOT NULL,          -- e.g. 'median_salary_real'
      year        SMALLINT    NOT NULL,
      value       NUMERIC,                       -- NULL = data not available (never 0 for missing)
      unit        TEXT        NOT NULL,          -- canonical unit, e.g. 'EUR/year'
      source      TEXT        NOT NULL,          -- source name, e.g. 'Banco de EspaÃ±a'
      source_url  TEXT        NOT NULL,          -- direct link to source data
      UNIQUE (country_id, metric, year)
    );

    CREATE TABLE political_data (
      id          BIGSERIAL   PRIMARY KEY,
      country_id  INTEGER     NOT NULL REFERENCES countries(id),
      metric      TEXT        NOT NULL,          -- e.g. 'president_annual_salary'
      year        SMALLINT    NOT NULL,
      value       NUMERIC,                       -- NULL = data not available
      unit        TEXT        NOT NULL,          -- canonical unit, e.g. 'EUR/year'
      source      TEXT        NOT NULL,
      source_url  TEXT        NOT NULL,
      UNIQUE (country_id, metric, year)
    );

    CREATE TABLE crime_statistics (
      id          BIGSERIAL   PRIMARY KEY,
      country_id  INTEGER     NOT NULL REFERENCES countries(id),
      metric      TEXT        NOT NULL,          -- e.g. 'homicide_rate_per_100k'
      year        SMALLINT    NOT NULL,
      value       NUMERIC,                       -- NULL = data not available
      unit        TEXT        NOT NULL,          -- canonical unit: 'rate per 100k inhabitants'
      source      TEXT        NOT NULL,
      source_url  TEXT        NOT NULL,
      UNIQUE (country_id, metric, year)
    );

    CREATE TABLE migration_data (
      id          BIGSERIAL   PRIMARY KEY,
      country_id  INTEGER     NOT NULL REFERENCES countries(id),
      metric      TEXT        NOT NULL,          -- e.g. 'first_residence_permits'
      year        SMALLINT    NOT NULL,
      value       NUMERIC,                       -- NULL = data not available
      unit        TEXT        NOT NULL,          -- canonical unit: 'count' or 'rate per 100k'
      source      TEXT        NOT NULL,
      source_url  TEXT        NOT NULL,
      UNIQUE (country_id, metric, year)
    );

    CREATE TABLE sync_log (
      id              BIGSERIAL   PRIMARY KEY,
      source_name     TEXT        NOT NULL,
      source_url      TEXT,
      synced_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
      status          TEXT        NOT NULL CHECK (status IN ('success', 'failure')),
      error_message   TEXT        -- NULL on success
    );
    ```

    Create `supabase/migrations/20260226000002_seed_countries.sql` with all EU-27 INSERT statements:

    ```sql
    -- supabase/migrations/20260226000002_seed_countries.sql
    -- EU-27 member states seed
    -- Ordered alphabetically by ISO code
    -- flag_emoji: Unicode regional indicator symbols

    INSERT INTO countries (code, name_es, name_en, flag_emoji) VALUES
      ('AT', 'Austria',        'Austria',        'ðŸ‡¦ðŸ‡¹'),
      ('BE', 'BÃ©lgica',        'Belgium',        'ðŸ‡§ðŸ‡ª'),
      ('BG', 'Bulgaria',       'Bulgaria',       'ðŸ‡§ðŸ‡¬'),
      ('HR', 'Croacia',        'Croatia',        'ðŸ‡­ðŸ‡·'),
      ('CY', 'Chipre',         'Cyprus',         'ðŸ‡¨ðŸ‡¾'),
      ('CZ', 'Chequia',        'Czechia',        'ðŸ‡¨ðŸ‡¿'),
      ('DK', 'Dinamarca',      'Denmark',        'ðŸ‡©ðŸ‡°'),
      ('EE', 'Estonia',        'Estonia',        'ðŸ‡ªðŸ‡ª'),
      ('FI', 'Finlandia',      'Finland',        'ðŸ‡«ðŸ‡®'),
      ('FR', 'Francia',        'France',         'ðŸ‡«ðŸ‡·'),
      ('DE', 'Alemania',       'Germany',        'ðŸ‡©ðŸ‡ª'),
      ('GR', 'Grecia',         'Greece',         'ðŸ‡¬ðŸ‡·'),
      ('HU', 'HungrÃ­a',        'Hungary',        'ðŸ‡­ðŸ‡º'),
      ('IE', 'Irlanda',        'Ireland',        'ðŸ‡®ðŸ‡ª'),
      ('IT', 'Italia',         'Italy',          'ðŸ‡®ðŸ‡¹'),
      ('LV', 'Letonia',        'Latvia',         'ðŸ‡±ðŸ‡»'),
      ('LT', 'Lituania',       'Lithuania',      'ðŸ‡±ðŸ‡¹'),
      ('LU', 'Luxemburgo',     'Luxembourg',     'ðŸ‡±ðŸ‡º'),
      ('MT', 'Malta',          'Malta',          'ðŸ‡²ðŸ‡¹'),
      ('NL', 'PaÃ­ses Bajos',   'Netherlands',    'ðŸ‡³ðŸ‡±'),
      ('PL', 'Polonia',        'Poland',         'ðŸ‡µðŸ‡±'),
      ('PT', 'Portugal',       'Portugal',       'ðŸ‡µðŸ‡¹'),
      ('RO', 'RumanÃ­a',        'Romania',        'ðŸ‡·ðŸ‡´'),
      ('SK', 'Eslovaquia',     'Slovakia',       'ðŸ‡¸ðŸ‡°'),
      ('SI', 'Eslovenia',      'Slovenia',       'ðŸ‡¸ðŸ‡®'),
      ('ES', 'EspaÃ±a',         'Spain',          'ðŸ‡ªðŸ‡¸'),
      ('SE', 'Suecia',         'Sweden',         'ðŸ‡¸ðŸ‡ª');
    ```

    Push migrations to the remote Supabase project:
    ```bash
    supabase db push
    ```

    Verify the migrations were applied:
    ```bash
    supabase migration list
    ```
    Both migration files should show status "applied".

    Verify the countries seed:
    ```bash
    # In Supabase SQL Editor or via CLI:
    supabase db query "SELECT COUNT(*) FROM countries;"
    ```
    Should return 27.

    Also verify the NOT NULL constraints work as intended:
    ```bash
    # This should FAIL (source is required):
    supabase db query "INSERT INTO economic_indicators (country_id, metric, year, value, unit, source, source_url) VALUES (1, 'test', 2024, 100, 'EUR/year', '', '') RETURNING id;" 2>/dev/null || echo "constraint enforced"

    # This should SUCCEED (NULL value is valid for missing data):
    supabase db query "INSERT INTO economic_indicators (country_id, metric, year, value, unit, source, source_url) VALUES (1, 'null_test', 2024, NULL, 'EUR/year', 'Test Source', 'https://example.com') RETURNING id;"
    # Clean up test row after:
    supabase db query "DELETE FROM economic_indicators WHERE metric = 'null_test';"
    ```

    Commit the migration files to git:
    ```bash
    git add supabase/migrations/
    git commit -m "feat(01-04): add initial schema migrations and EU-27 countries seed"
    git push origin main
    ```
  </action>
  <verify>
    supabase migration list shows both migrations as "applied".
    supabase db query "SELECT COUNT(*) FROM countries;" returns 27.
    supabase db query "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;" returns: countries, crime_statistics, economic_indicators, migration_data, political_data, sync_log.
    npm run build still passes (schema changes don't break the app build).
  </verify>
  <done>
    Both migration files written and pushed to Supabase.
    All 6 tables exist in remote Supabase project.
    countries table has 27 rows (all EU member states).
    NOT NULL constraints verified on source/source_url columns.
    NULL value accepted for metric value column.
    Migration files committed to git.
  </done>
</task>

</tasks>

<verification>
Full phase check for foundation completion:
1. `supabase migration list` shows 2 migrations applied
2. `supabase db query "SELECT COUNT(*) FROM countries;"` returns 27
3. All 6 tables present: countries, economic_indicators, political_data, crime_statistics, migration_data, sync_log
4. `supabase db query "SELECT column_name, is_nullable FROM information_schema.columns WHERE table_name = 'economic_indicators' ORDER BY column_name;"` confirms:
   - source: NOT NULL
   - source_url: NOT NULL
   - value: nullable
5. `npm run build` passes (full stack build with Supabase connection)
6. `npx tsc --noEmit` passes
7. Vercel production deployment reflects the full Phase 1 foundation (from git push)

Phase 1 Success Criteria verification:
- [ ] Site live on Vercel at /es/ and /en/ â€” locale detection redirects correctly
- [ ] Language switcher appears and switches locale
- [ ] All 6 DB tables exist in Supabase, created via migration files
- [ ] countries table has all EU-27 entries
- [ ] Any UI string in a component uses t('key') â€” zero hardcoded Spanish/English
</verification>

<success_criteria>
- Migration files version-controlled in supabase/migrations/
- All 6 tables deployed to remote Supabase project
- countries table seeded with 27 EU member states
- NOT NULL constraints on source and source_url enforce data provenance at DB level
- UNIQUE constraints on (country_id, metric, year) in all metric tables
- sync_log status column constrained to 'success' or 'failure'
- npm run build passes and Vercel deployment succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` with:
- Confirmation that both migrations applied successfully
- countries table row count (should be 27)
- List of all table names created
- Confirmation of NOT NULL constraint enforcement on source columns
- Any schema deviations from the research recommendations and why
- Phase 1 overall completion status

This SUMMARY marks Phase 1 complete. Phase 2 (Economy Section) can begin.
</output>
