---
phase: 01-foundation
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - middleware.ts
  - next.config.ts
  - src/i18n/routing.ts
  - src/i18n/navigation.ts
  - src/i18n/request.ts
  - src/app/[locale]/layout.tsx
  - src/app/[locale]/page.tsx
  - src/components/layout/LocaleSwitcher.tsx
  - src/components/layout/Navigation.tsx
  - messages/es.json
  - messages/en.json
autonomous: true
requirements:
  - INFRA-04
  - INFRA-05
  - UX-05
  - UX-06

must_haves:
  truths:
    - "Navigating to `/` redirects to `/es/` automatically based on browser Accept-Language header"
    - "Navigating to `/en/` renders the English home page"
    - "The language switcher appears on every page and clicking it switches locale without a full page reload"
    - "The navigation links to all five sections (Economy, Political Class, Immigration, Crime, Comparator) appear on every page and correctly prefix the locale in their URLs"
    - "Zero hardcoded Spanish or English text exists in any component — every visible string uses `t('key')`"
    - "`npm run build` passes and `npx tsc --noEmit` produces zero errors"
  artifacts:
    - path: "middleware.ts"
      provides: "next-intl locale detection and redirect middleware"
      contains: "createMiddleware"
    - path: "src/i18n/routing.ts"
      provides: "defineRouting with locales: ['es', 'en'], defaultLocale: 'es'"
      exports: ["routing"]
    - path: "src/i18n/navigation.ts"
      provides: "locale-aware Link, useRouter, usePathname, redirect"
      exports: ["Link", "redirect", "usePathname", "useRouter", "getPathname"]
    - path: "src/i18n/request.ts"
      provides: "getRequestConfig loading messages per locale"
    - path: "src/app/[locale]/layout.tsx"
      provides: "Root locale layout with NextIntlClientProvider, Navigation, LocaleSwitcher"
    - path: "src/components/layout/LocaleSwitcher.tsx"
      provides: "Client Component for switching between /es/ and /en/"
    - path: "src/components/layout/Navigation.tsx"
      provides: "Nav with locale-aware links to all 5 sections"
    - path: "messages/es.json"
      provides: "Spanish translations for Navigation, LocaleSwitcher, HomePage namespaces"
    - path: "messages/en.json"
      provides: "English translations for same namespaces"
  key_links:
    - from: "middleware.ts"
      to: "src/i18n/routing.ts"
      via: "createMiddleware(routing)"
      pattern: "createMiddleware"
    - from: "src/app/[locale]/layout.tsx"
      to: "src/components/layout/Navigation.tsx"
      via: "import and render in layout body"
      pattern: "Navigation"
    - from: "src/components/layout/LocaleSwitcher.tsx"
      to: "src/i18n/navigation.ts"
      via: "usePathname + useRouter from @/i18n/navigation"
      pattern: "from '@/i18n/navigation'"
    - from: "next.config.ts"
      to: "src/i18n/request.ts"
      via: "createNextIntlPlugin('./src/i18n/request.ts')"
      pattern: "createNextIntlPlugin"
---

<objective>
Wire next-intl v4 into the Next.js 14 App Router, establishing the `[locale]` directory structure, locale detection middleware, language switcher, and full section navigation — before any content pages are built.

Purpose: This is the immovable constraint that cannot be retrofitted. The App Router directory tree, once routes are added outside `[locale]`, cannot be restructured without moving every file. This plan locks in the routing structure permanently.

Output: Bilingual routing at `/es/` and `/en/`, locale detection middleware, language switcher component, and section navigation — all using `t('key')` with zero hardcoded text.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

<!-- Key patterns from research for executor reference -->
<interfaces>
<!-- next-intl v4 routing setup — use these exact patterns -->

```typescript
// src/i18n/routing.ts
import {defineRouting} from 'next-intl/routing';

export const routing = defineRouting({
  locales: ['es', 'en'],
  defaultLocale: 'es'  // Spanish is primary language
});
```

```typescript
// middleware.ts (project root, same level as package.json)
import createMiddleware from 'next-intl/middleware';
import {routing} from './src/i18n/routing';

export default createMiddleware(routing);

export const config = {
  matcher: '/((?!api|trpc|_next|_vercel|.*\\..*).*)'
};
```

```typescript
// src/i18n/navigation.ts
import {createNavigation} from 'next-intl/navigation';
import {routing} from './routing';

export const {Link, redirect, usePathname, useRouter, getPathname} =
  createNavigation(routing);
// Use these instead of next/navigation equivalents — they auto-prefix locale
```

```typescript
// src/i18n/request.ts
import {getRequestConfig} from 'next-intl/server';
import {hasLocale} from 'next-intl';
import {routing} from './routing';

export default getRequestConfig(async ({requestLocale}) => {
  const requested = await requestLocale;
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale;
  return {locale};
});
```

```typescript
// next.config.ts — wrap with next-intl plugin
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n/request.ts');

const nextConfig = {};
export default withNextIntl(nextConfig);
```

```typescript
// src/app/[locale]/layout.tsx
import {NextIntlClientProvider, hasLocale} from 'next-intl';
import {notFound} from 'next/navigation';
import {setRequestLocale} from 'next-intl/server';
import {routing} from '@/i18n/routing';

export function generateStaticParams() {
  return routing.locales.map((locale) => ({locale}));
}

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{locale: string}>;
}) {
  const {locale} = await params;  // MUST await — params is Promise in Next.js 14+ with next-intl v4

  if (!hasLocale(routing.locales, locale)) {
    notFound();
  }

  setRequestLocale(locale);

  return (
    <html lang={locale}>
      <body>
        <NextIntlClientProvider>
          {/* Navigation and LocaleSwitcher here */}
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  );
}
```

// Language switcher — Client Component
// From: src/i18n/navigation — NOT next/navigation
'use client';
import {useLocale} from 'next-intl';
import {usePathname, useRouter} from '@/i18n/navigation';
import {routing} from '@/i18n/routing';
```

// Server Component translation
import {getTranslations} from 'next-intl/server';
const t = await getTranslations('Namespace');  // async — NOT useTranslations

// Client Component translation
'use client';
import {useTranslations} from 'next-intl';
const t = useTranslations('Namespace');  // hook — NOT getTranslations
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-intl and wire routing infrastructure</name>
  <files>
    package.json
    src/i18n/routing.ts
    src/i18n/navigation.ts
    src/i18n/request.ts
    middleware.ts
    next.config.ts
  </files>
  <action>
    Install next-intl: `npm install next-intl`

    Create `src/i18n/routing.ts` with `defineRouting({ locales: ['es', 'en'], defaultLocale: 'es' })`. Export `routing`.

    Create `src/i18n/navigation.ts` using `createNavigation(routing)`. Export `Link`, `redirect`, `usePathname`, `useRouter`, `getPathname`. These replace `next/link` and `next/navigation` everywhere in the codebase.

    Create `src/i18n/request.ts` using `getRequestConfig` with `hasLocale` validation and fallback to `defaultLocale`. The `messages` key is not set here (messages will be loaded inline in layout.tsx via `NextIntlClientProvider`).

    Create `middleware.ts` at the **project root** (same level as `package.json`, not inside `src/app/`). Use `createMiddleware(routing)` with the matcher pattern excluding `api`, `_next`, `_vercel`, and files with extensions.

    Update `next.config.ts` to wrap with `createNextIntlPlugin('./src/i18n/request.ts')`. Use TypeScript import syntax — do NOT use `require()`.

    After changes, run `npm run build` to confirm no errors. Fix any TypeScript errors before moving to Task 2.

    PITFALL GUARD: If build fails with "require() of ES Module", the issue is in next.config.ts using CommonJS syntax. Convert to TypeScript imports.
    PITFALL GUARD: If locale redirect does not work, verify `middleware.ts` is at project root, not inside `src/app/`.
  </action>
  <verify>
    npm run build passes.
    npx tsc --noEmit passes.
    Navigating to http://localhost:3000/ in dev mode redirects to http://localhost:3000/es/ (or /en/ based on browser language).
  </verify>
  <done>next-intl installed, routing infrastructure files created, middleware at project root, locale redirect working in dev</done>
</task>

<task type="auto">
  <name>Task 2: Create locale layout, translation files, Language Switcher, and Navigation</name>
  <files>
    src/app/[locale]/layout.tsx
    src/app/[locale]/page.tsx
    src/components/layout/LocaleSwitcher.tsx
    src/components/layout/Navigation.tsx
    messages/es.json
    messages/en.json
  </files>
  <action>
    FIRST: Move (or replace) the existing `src/app/layout.tsx` and `src/app/page.tsx` to `src/app/[locale]/layout.tsx` and `src/app/[locale]/page.tsx`. Delete the old root-level files if create-next-app created them. The `src/app/` directory should NOT have a page.tsx at the root after this step — only the `[locale]` subdirectory.

    Create `src/app/[locale]/layout.tsx` using the exact pattern from the research:
    - Import `NextIntlClientProvider`, `hasLocale` from `next-intl`
    - Import `notFound` from `next/navigation`
    - Import `setRequestLocale` from `next-intl/server`
    - Import `routing` from `@/i18n/routing`
    - `generateStaticParams()` returns locale array
    - `params: Promise<{locale: string}>` — MUST `await params`
    - Call `setRequestLocale(locale)` for static rendering
    - Wrap body with `<NextIntlClientProvider>`
    - Include `<Navigation />` and `<LocaleSwitcher />` inside the provider

    Create `messages/es.json`:
    ```json
    {
      "Navigation": {
        "economy": "Economía",
        "politics": "Clase Política",
        "immigration": "Inmigración",
        "crime": "Criminalidad",
        "comparator": "Comparador",
        "home": "Inicio"
      },
      "LocaleSwitcher": {
        "label": "Idioma",
        "es": "Español",
        "en": "English"
      },
      "HomePage": {
        "title": "EuroData",
        "subtitle": "Datos oficiales. Sin editoriales.",
        "description": "Seguimiento de la calidad de vida y poder adquisitivo de los ciudadanos frente a la clase política."
      }
    }
    ```

    Create `messages/en.json` with equivalent English translations:
    ```json
    {
      "Navigation": {
        "economy": "Economy",
        "politics": "Political Class",
        "immigration": "Immigration",
        "crime": "Crime",
        "comparator": "Comparator",
        "home": "Home"
      },
      "LocaleSwitcher": {
        "label": "Language",
        "es": "Español",
        "en": "English"
      },
      "HomePage": {
        "title": "EuroData",
        "subtitle": "Official data. No editorials.",
        "description": "Tracking citizens' quality of life and purchasing power against the political class."
      }
    }
    ```

    Create `src/components/layout/LocaleSwitcher.tsx` as a `'use client'` component:
    - Import `useLocale` from `next-intl`
    - Import `usePathname`, `useRouter` from `@/i18n/navigation` (NOT `next/navigation`)
    - Import `routing` from `@/i18n/routing`
    - Render buttons for each locale; active locale is disabled and bold
    - On click: `router.replace(pathname, {locale: newLocale})` then `router.refresh()`
    - Include `useTranslations('LocaleSwitcher')` for the label text

    Create `src/components/layout/Navigation.tsx` as a Client Component (`'use client'`):
    - Import `Link` from `@/i18n/navigation` (NOT `next/link`)
    - Import `useTranslations` from `next-intl`
    - Render navigation links to 5 section paths: `/economy`, `/politics`, `/immigration`, `/crime`, `/comparator`
    - Section pages do not exist yet — the links are placeholders for now. They will return 404 until Phases 2-5 build the pages.
    - Use `useTranslations('Navigation')` for all link labels — zero hardcoded text

    Update `src/app/[locale]/page.tsx` to be a Server Component that uses `getTranslations('HomePage')`:
    ```typescript
    import {getTranslations} from 'next-intl/server';
    import {setRequestLocale} from 'next-intl/server';

    export default async function HomePage({
      params
    }: {
      params: Promise<{locale: string}>;
    }) {
      const {locale} = await params;
      setRequestLocale(locale);
      const t = await getTranslations('HomePage');

      return (
        <main>
          <h1>{t('title')}</h1>
          <p>{t('subtitle')}</p>
          <p>{t('description')}</p>
        </main>
      );
    }
    ```

    ENFORCEMENT CHECK before committing: Run `grep -r "Economía\|Economy\|Español\|Spanish\|Inglés\|English\|Inicio\|Home\|Datos\|Data" src/` — if any hardcoded text is found in `.tsx` or `.ts` files, remove it and use `t('key')` instead.
  </action>
  <verify>
    npm run build passes.
    npx tsc --noEmit passes.
    Visiting http://localhost:3000/es/ shows the Spanish home page with EuroData title and subtitle.
    Visiting http://localhost:3000/en/ shows the English home page.
    The language switcher is visible on both pages and switching locales works without a full page reload.
    The navigation bar shows all 5 section links.
    grep -r "Economía\|Economy" src/ returns zero results (no hardcoded text in components).
  </verify>
  <done>
    Locale layout renders correctly in both /es/ and /en/.
    LocaleSwitcher switches locale without full reload.
    Navigation shows 5 section links using t('key').
    Zero hardcoded Spanish or English text in any .tsx/.ts file.
    npm run build and npx tsc --noEmit pass.
  </done>
</task>

</tasks>

<verification>
Full phase check:
1. `npm run build` passes
2. `npx tsc --noEmit` produces zero errors
3. `grep -r "Economía\|Economy\|Español" src/` returns zero hits (no hardcoded text)
4. `middleware.ts` exists at project root (not inside src/app/)
5. `src/app/[locale]/layout.tsx` exists — no `src/app/layout.tsx` or `src/app/page.tsx` at root
6. Both `messages/es.json` and `messages/en.json` exist with Navigation, LocaleSwitcher, HomePage namespaces
7. Browser test: `/` → redirects to `/es/` or `/en/` based on Accept-Language header
8. Locale switcher changes URL between `/es/[path]` and `/en/[path]` without full reload
</verification>

<success_criteria>
- next-intl v4 routing infrastructure in place with `[locale]` directory structure
- Locale detection middleware redirects `/` to correct language
- Language switcher functional on all pages
- Navigation component with 5 section links present on all pages
- All visible text uses `t('key')` — zero hardcoded strings
- TypeScript strict mode passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` with:
- Confirmation that locale redirect is working
- next-intl version installed (from package.json)
- Any deviations from the patterns in 01-RESEARCH.md
- Status of params awaiting behavior (was it required for Next.js 14 or no-op?)
</output>
