---
phase: 01-foundation
plan: "03"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - package.json
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/providers/QueryProvider.tsx
  - src/app/[locale]/layout.tsx
  - .env.local
autonomous: false
requirements:
  - INFRA-03
  - INFRA-09

must_haves:
  truths:
    - "A Supabase project exists and its URL and publishable key are in .env.local"
    - "The browser Supabase client (`src/lib/supabase/client.ts`) can be imported in Client Components without errors"
    - "The server Supabase client (`src/lib/supabase/server.ts`) can be imported in Server Components without errors"
    - "TanStack Query provider wraps the locale layout — all client components have access to QueryClient"
    - "`npm run build` passes and `npx tsc --noEmit` produces zero errors"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "createBrowserClient factory for use in Client Components"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "createServerClient factory for use in Server Components and Route Handlers"
      exports: ["createClient"]
    - path: "src/providers/QueryProvider.tsx"
      provides: "TanStack Query client provider with per-request QueryClient via useState"
      exports: ["QueryProvider"]
  key_links:
    - from: "src/lib/supabase/client.ts"
      to: "process.env.NEXT_PUBLIC_SUPABASE_URL"
      via: "createBrowserClient"
      pattern: "NEXT_PUBLIC_SUPABASE_URL"
    - from: "src/providers/QueryProvider.tsx"
      to: "src/app/[locale]/layout.tsx"
      via: "wraps children in layout body"
      pattern: "QueryProvider"

user_setup:
  - service: supabase
    why: "Database and API for all data storage"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard → Project Settings → API → Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard → Project Settings → API → Project API keys → anon public"
    dashboard_config:
      - task: "Create a new Supabase project"
        location: "supabase.com → New project → set name 'eurodata', choose region closest to Spain (e.g., eu-west-1)"
---

<objective>
Install and configure the Supabase SSR dual-client setup (`@supabase/ssr`) and the TanStack Query provider, then wire the provider into the locale layout.

Purpose: Every data-fetching hook in Phases 2-5 depends on the TanStack Query provider being available at the root. The Supabase client factories must be established before the database schema plan (01-04) can verify connectivity. This plan can run in parallel with 01-02 since it touches different files.

Output: Two Supabase client factories (browser + server), a TanStack Query provider component, and the provider wired into the locale layout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

<interfaces>
<!-- Exact patterns for Supabase SSR dual clients — do not deviate -->

```typescript
// src/lib/supabase/client.ts
// Use createBrowserClient ONLY in 'use client' components
// Do NOT use this in Server Components, Route Handlers, or middleware
import {createBrowserClient} from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
  );
}
```

```typescript
// src/lib/supabase/server.ts
// Use createServerClient ONLY in Server Components, Route Handlers, Actions
// Do NOT use this in 'use client' components
import {createServerClient} from '@supabase/ssr';
import {cookies} from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({name, value, options}) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // Server Component — cookie writes ignored (handled by middleware)
          }
        }
      }
    }
  );
}
```

```typescript
// src/providers/QueryProvider.tsx
// CRITICAL: QueryClient MUST be created inside useState to avoid
// shared state between SSR requests. Do NOT create at module scope.
'use client';

import {QueryClient, QueryClientProvider} from '@tanstack/react-query';
import {ReactQueryDevtools} from '@tanstack/react-query-devtools';
import {useState} from 'react';

export default function QueryProvider({children}: {children: React.ReactNode}) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 60 * 1000,   // 1 minute — economic data is mostly static
            refetchOnWindowFocus: false
          }
        }
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```
</interfaces>
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Create Supabase project and configure environment variables</name>
  <files>
    .env.local
  </files>
  <action>
    Create the Supabase project and configure local environment variables. This requires dashboard interaction.

    Steps:
    1. Go to supabase.com → New project
       - Name: `eurodata`
       - Region: EU West (or closest to Spain/your location)
       - Database password: generate a strong password and save it securely
    2. Wait for project to provision (1-2 minutes)
    3. Go to Project Settings → API
       - Copy "Project URL" → this is `NEXT_PUBLIC_SUPABASE_URL`
       - Copy "anon public" key → this is `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
    4. Create `.env.local` in the project root:
       ```
       NEXT_PUBLIC_SUPABASE_URL=https://your-project-ref.supabase.co
       NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-anon-public-key
       ```
    5. Also add these environment variables to the Vercel project:
       - Vercel Dashboard → Project → Settings → Environment Variables
       - Add both variables for Production, Preview, and Development environments

    SECURITY: `.env.local` must be in `.gitignore` (create-next-app adds this by default). Verify before continuing.
  </action>
  <verify>
    cat .env.local shows both NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY with real values.
    grep ".env.local" .gitignore returns a match (file is gitignored).
  </verify>
  <done>Supabase project created, .env.local configured with real URL and key, variables added to Vercel dashboard</done>
</task>

<task type="auto">
  <name>Task 2: Install Supabase packages, create client factories, and wire TanStack Query</name>
  <files>
    package.json
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/providers/QueryProvider.tsx
    src/app/[locale]/layout.tsx
  </files>
  <action>
    Install packages:
    ```bash
    npm install @supabase/supabase-js @supabase/ssr
    npm install @tanstack/react-query @tanstack/react-query-devtools
    ```

    Create `src/lib/supabase/client.ts` using `createBrowserClient` from `@supabase/ssr`. Export `createClient` function. This is the ONLY Supabase client for use in `'use client'` components. Do NOT install or import from `@supabase/auth-helpers-nextjs` (deprecated).

    Create `src/lib/supabase/server.ts` using `createServerClient` from `@supabase/ssr`. Export async `createClient` function that reads cookies via `cookies()` from `next/headers`. This is the ONLY Supabase client for use in Server Components and Route Handlers.

    Create `src/providers/QueryProvider.tsx` as a `'use client'` component. Create `QueryClient` inside `useState(() => new QueryClient(...))` — NEVER at module scope (causes shared state between SSR requests). Include `ReactQueryDevtools` (renders only in development automatically). Set `staleTime: 60 * 1000` and `refetchOnWindowFocus: false`.

    Update `src/app/[locale]/layout.tsx` to wrap the layout body with `<QueryProvider>`. Place it inside `<NextIntlClientProvider>` or outside — either works, but outside is simpler:
    ```typescript
    // In layout.tsx body:
    <html lang={locale}>
      <body>
        <NextIntlClientProvider>
          <QueryProvider>
            <Navigation />
            <LocaleSwitcher />
            {children}
          </QueryProvider>
        </NextIntlClientProvider>
      </body>
    </html>
    ```

    If Plan 02 has not yet been executed (parallel wave), the layout.tsx may not exist yet. In that case, create a placeholder `src/app/[locale]/layout.tsx` with just the QueryProvider wrapper and a TODO comment for Plan 02 to add next-intl. The final merged layout.tsx must include both.

    After wiring, verify the Supabase connection by adding a temporary test in `src/app/[locale]/page.tsx`:
    ```typescript
    import {createClient} from '@/lib/supabase/server';

    // Temporary connection test — remove after verifying
    const supabase = await createClient();
    const {error} = await supabase.from('countries').select('count').single();
    // error will say "relation does not exist" until Plan 04 creates the table
    // but it should NOT say "invalid API key" or "connection refused"
    console.log('Supabase connection test:', error?.message ?? 'OK');
    ```

    Remove the test code after verifying the connection is valid (error should mention the table not existing, not a connection/auth failure).

    Run `npm run build` and `npx tsc --noEmit`. Fix any TypeScript errors before finishing.
  </action>
  <verify>
    npm run build passes.
    npx tsc --noEmit passes.
    npm run dev — check terminal for Supabase connection log; error should say "relation 'countries' does not exist" (table not yet created) NOT "invalid API key" or network error.
    QueryProvider is rendered in the locale layout — verify by checking if ReactQueryDevtools button appears in the browser in dev mode.
  </verify>
  <done>
    @supabase/ssr package installed, browser and server client factories created.
    TanStack Query provider wired into locale layout.
    Supabase connection verified (table missing error expected — connection itself works).
    npm run build and npx tsc --noEmit pass.
  </done>
</task>

</tasks>

<verification>
Full check:
1. `npm run build` passes
2. `npx tsc --noEmit` produces zero errors
3. `.env.local` exists with real Supabase credentials (not the example placeholders)
4. `grep "auth-helpers" package.json` returns no results (deprecated package not installed)
5. `src/lib/supabase/client.ts` uses `createBrowserClient` from `@supabase/ssr`
6. `src/lib/supabase/server.ts` uses `createServerClient` from `@supabase/ssr` with cookie handling
7. `src/providers/QueryProvider.tsx` uses `useState(() => new QueryClient(...))` (not module-level)
8. ReactQueryDevtools button visible in dev browser
9. Vercel environment variables configured for both SUPABASE vars
</verification>

<success_criteria>
- Supabase project created and credentials in .env.local and Vercel
- Browser client factory at src/lib/supabase/client.ts
- Server client factory at src/lib/supabase/server.ts
- TanStack Query provider wrapping locale layout
- npm run build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` with:
- Supabase project reference ID (from the URL: `supabase.co/project/[ref-id]`)
- Confirmation that .env.local has real values
- Confirmation that Vercel environment variables are set
- Any issues encountered during setup
</output>
